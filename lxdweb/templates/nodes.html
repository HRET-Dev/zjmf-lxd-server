<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .title }}</title>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="bg-gray-50">
    {{template "header.html" .}}
    <div class="container mx-auto px-4 py-8">
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
                    <span class="iconify text-blue-600" data-icon="mdi:server-network" data-width="36"></span>
                    节点管理
                </h1>
                <p class="text-gray-600 mt-1">管理和监控所有 LXD 节点</p>
            </div>
            <button onclick="showAddModal()" class="flex items-center gap-2 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-2 text-sm font-medium rounded-lg btn-hover shadow-md">
                <span class="iconify" data-icon="mdi:plus-circle" data-width="18"></span>
                添加节点
            </button>
        </div>
        <div id="nodesGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
            <div class="col-span-full text-center py-12">
                <span class="iconify animate-pulse-slow text-blue-500" data-icon="mdi:loading" data-width="48"></span>
                <p class="text-gray-500 mt-4">加载节点数据...</p>
            </div>
        </div>
    </div>
    <dialog id="nodeModal" class="modal">
        <div class="modal-box">
            <h3 id="modalTitle" class="font-bold text-lg mb-4">添加节点</h3>
            <form id="nodeForm" class="space-y-4">
                <input type="hidden" id="nodeId">
                <div class="form-control">
                    <label class="label"><span class="label-text">节点名称 *</span></label>
                    <input type="text" id="nodeName" required class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">API地址 *</span></label>
                    <input type="text" id="nodeAddress" required placeholder="" class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">API密钥</span></label>
                    <input type="password" id="nodeApiKey" class="input input-bordered">
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">描述</span></label>
                    <textarea id="nodeDescription" rows="3" class="textarea textarea-bordered"></textarea>
                </div>
                
                <div class="divider text-sm text-gray-600">同步配置</div>
                
                <div class="form-control">
                    <label class="label"><span class="label-text">同步预设</span></label>
                    <select id="syncPreset" onchange="handlePresetChange()" class="select select-bordered">
                        <option value="low">低配 (批次3, 间隔10秒) - 适合低配置服务器</option>
                        <option value="medium" selected>中配 (批次5, 间隔5秒) - 推荐配置</option>
                        <option value="high">高配 (批次10, 间隔3秒) - 适合高配置服务器</option>
                        <option value="custom">自定义</option>
                    </select>
                    <label class="label">
                        <span class="label-text-alt text-gray-500">控制节点同步容器时的批次大小和间隔</span>
                    </label>
                </div>
                
                <div id="customSyncSettings" class="hidden space-y-4">
                    <div class="form-control">
                        <label class="label"><span class="label-text">批次大小</span></label>
                        <input type="number" id="batchSize" min="1" max="20" value="5" class="input input-bordered">
                        <label class="label">
                            <span class="label-text-alt text-gray-500">每批同时处理的容器数量</span>
                        </label>
                    </div>
                    <div class="form-control">
                        <label class="label"><span class="label-text">批次间隔 (秒)</span></label>
                        <input type="number" id="batchInterval" min="1" max="30" value="5" class="input input-bordered">
                        <label class="label">
                            <span class="label-text-alt text-gray-500">批次之间的等待时间</span>
                        </label>
                    </div>
                </div>
                
                <div class="modal-action">
                    <button type="button" onclick="closeModal()" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 rounded-lg transition">取消</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 rounded-lg transition">保存</button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop"><button onclick="closeModal()">close</button></form>
    </dialog>
    <script>
        $(document).ready(function() {
            loadNodes();
        });
        function loadNodes() {
            $.get('/api/nodes', function(result) {
                if (result.code === 200) {
                    renderNodes(result.data);
                } else {
                    $('#nodesGrid').html('<div class="col-span-full text-center py-12 text-red-600">加载失败: ' + result.msg + '</div>');
                }
            }).fail(function() {
                $('#nodesGrid').html('<div class="col-span-full text-center py-12 text-red-600">加载失败，请检查网络连接</div>');
            });
        }
        function renderNodes(nodes) {
            if (!nodes || nodes.length === 0) {
                $('#nodesGrid').html(`
                    <div class="col-span-full text-center py-12">
                        <span class="iconify text-gray-300 mb-4" data-icon="mdi:server-off" data-width="64"></span>
                        <p class="text-gray-500 mt-4">暂无节点，点击"添加节点"开始</p>
                    </div>
                `);
                return;
            }
            const cards = nodes.map(node => createNodeCard(node)).join('');
            $('#nodesGrid').html(cards);
        }
        function createNodeCard(node) {
            const statusBadge = getStatusBadge(node.status);
            const sysInfo = node.system_info || {};
            const system = sysInfo.system || {};
            return `
                <div class="bg-white rounded-lg border border-gray-200 card-hover">
                    <div class="p-4">
                        <div class="flex justify-between items-start mb-3">
                            <div class="flex-1 min-w-0">
                                <h3 class="font-semibold text-gray-800 text-base truncate">${node.name}</h3>
                                <p class="text-xs text-gray-500 mt-0.5 truncate">${node.description || '暂无描述'}</p>
                            </div>
                            ${statusBadge}
                        </div>
                        ${sysInfo.version ? `
                            <div class="bg-gradient-to-br from-gray-50 to-gray-100 rounded-md p-3 mb-3 space-y-1.5 text-xs">
                                <div class="flex items-center justify-between">
                                    <span class="text-gray-600">版本</span>
                                    <span class="font-medium text-gray-800">${sysInfo.version}</span>
                                </div>
                                ${system.arch ? `
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-600">架构</span>
                                        <span class="px-2 py-0.5 bg-blue-100 text-blue-700 rounded font-medium">${system.arch}</span>
                                    </div>
                                ` : ''}
                                ${sysInfo.lxd_version ? `
                                    <div class="flex items-center justify-between">
                                        <span class="text-gray-600">LXD</span>
                                        <span class="font-medium text-gray-800">${sysInfo.lxd_version}</span>
                                    </div>
                                ` : ''}
                                ${system.distribution ? `
                                    <div class="pt-1 border-t border-gray-200">
                                        <span class="text-gray-600">系统</span>
                                        <div class="text-gray-700 font-medium mt-0.5 leading-tight">${system.distribution.split(' (')[0]}</div>
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div class="bg-amber-50 border border-amber-200 rounded-md p-2.5 mb-3 text-xs text-amber-700 flex items-center gap-1.5">
                                <svg class="w-3.5 h-3.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span>无法获取系统信息</span>
                            </div>
                        `}
                        <div class="flex items-center gap-1.5 text-xs text-gray-500 mb-3 bg-gray-50 rounded px-2 py-1.5">
                            <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
                            </svg>
                            <span class="truncate font-mono">${node.address.replace(/^https?:\/\//, '')}</span>
                        </div>
                        <div class="flex gap-1.5 mb-2">
                            <a href="/nodes/${node.id}" class="flex-1 px-2 py-1.5 text-xs font-medium text-indigo-700 bg-indigo-50 hover:bg-indigo-100 border border-indigo-200 rounded smooth-transition text-center flex items-center justify-center gap-1">
                                <span class="iconify" data-icon="mdi:information" data-width="14"></span>
                                详情
                            </a>
                            <button onclick="testNode(${node.id})" class="flex-1 px-2 py-1.5 text-xs font-medium text-green-700 bg-green-50 hover:bg-green-100 border border-green-200 rounded smooth-transition flex items-center justify-center gap-1" title="测试连接">
                                <span class="iconify" data-icon="mdi:lan-connect" data-width="14"></span>
                                测试
                            </button>
                        </div>
                        <div class="flex gap-1.5">
                            <button onclick="refreshNode(${node.id})" class="flex-1 px-2 py-1.5 text-xs font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 border border-purple-200 rounded smooth-transition flex items-center justify-center gap-1" title="刷新节点信息">
                                <span class="iconify" data-icon="mdi:refresh" data-width="14"></span>
                                刷新
                            </button>
                            <button onclick="editNode(${node.id})" class="flex-1 px-2 py-1.5 text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded smooth-transition flex items-center justify-center gap-1">
                                <span class="iconify" data-icon="mdi:pencil" data-width="14"></span>
                                编辑
                            </button>
                            <button onclick="deleteNode(${node.id})" class="flex-1 px-2 py-1.5 text-xs font-medium text-red-700 bg-red-50 hover:bg-red-100 border border-red-200 rounded smooth-transition flex items-center justify-center gap-1">
                                <span class="iconify" data-icon="mdi:delete" data-width="14"></span>
                                删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        function getStatusBadge(status) {
            const badges = {
                'active': '<span class="px-2 py-0.5 text-xs font-medium text-green-700 bg-green-100 rounded-full flex items-center gap-1"><span class="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span>在线</span>',
                'inactive': '<span class="px-2 py-0.5 text-xs font-medium text-gray-600 bg-gray-100 rounded-full">离线</span>',
                'error': '<span class="px-2 py-0.5 text-xs font-medium text-red-700 bg-red-100 rounded-full">错误</span>'
            };
            return badges[status] || badges.inactive;
        }
        function handlePresetChange() {
            const preset = $('#syncPreset').val();
            const customSettings = document.getElementById('customSyncSettings');
            
            if (preset === 'custom') {
                customSettings.classList.remove('hidden');
            } else {
                customSettings.classList.add('hidden');
            }
        }
        
        function showAddModal() {
            $('#modalTitle').text('添加节点');
            $('#nodeForm')[0].reset();
            $('#nodeId').val('');
            $('#syncPreset').val('medium');
            $('#batchSize').val(5);
            $('#batchInterval').val(5);
            handlePresetChange();
            document.getElementById('nodeModal').showModal();
        }
        function editNode(id) {
            $.get(`/api/nodes/${id}`, function(result) {
                if (result.code === 200) {
                    const node = result.data;
                    $('#modalTitle').text('编辑节点');
                    $('#nodeId').val(node.id);
                    $('#nodeName').val(node.name);
                    $('#nodeAddress').val(node.address);
                    $('#nodeApiKey').val(node.api_key);
                    $('#nodeDescription').val(node.description);
                    $('#syncPreset').val(node.sync_preset || 'medium');
                    $('#batchSize').val(node.batch_size || 5);
                    $('#batchInterval').val(node.batch_interval || 5);
                    handlePresetChange();
                    document.getElementById('nodeModal').showModal();
                } else {
                    alert('获取节点信息失败');
                }
            });
        }
        function closeModal() {
            document.getElementById('nodeModal').close();
        }
        $('#nodeForm').on('submit', function(e) {
            e.preventDefault();
            const id = $('#nodeId').val();
            const syncPreset = $('#syncPreset').val();
            const data = {
                name: $('#nodeName').val(),
                address: $('#nodeAddress').val(),
                api_key: $('#nodeApiKey').val(),
                description: $('#nodeDescription').val(),
                sync_preset: syncPreset,
                batch_size: parseInt($('#batchSize').val()) || 5,
                batch_interval: parseInt($('#batchInterval').val()) || 5
            };
            const url = id ? `/api/nodes/${id}` : '/api/nodes';
            const method = id ? 'PUT' : 'POST';
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(data),
                success: function(result) {
                    if (result.code === 200) {
                        closeModal();
                        loadNodes();
                        alert(id ? '节点更新成功' : '节点创建成功');
                    } else {
                        alert(result.msg);
                    }
                },
                error: function() {
                    alert('操作失败');
                }
            });
        });
        function testNode(id) {
            const $btn = $(`button[onclick="testNode(${id})"]`);
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span>').prop('disabled', true);
            $.post(`/api/nodes/${id}/test`, function(result) {
                $btn.html(originalHtml).prop('disabled', false);
                alert(result.msg);
                loadNodes();
            }).fail(function() {
                $btn.html(originalHtml).prop('disabled', false);
                alert('测试失败');
            });
        }
        function refreshNode(id) {
            const $btn = $(`button[onclick="refreshNode(${id})"]`);
            const originalHtml = $btn.html();
            $btn.html('<span class="loading loading-spinner loading-xs"></span>').prop('disabled', true);
            $.post(`/api/nodes/${id}/refresh`, function(result) {
                $btn.html(originalHtml).prop('disabled', false);
                if (result.code === 200) {
                    setTimeout(() => loadNodes(), 500);
                } else {
                    alert(result.msg);
                }
            }).fail(function() {
                $btn.html(originalHtml).prop('disabled', false);
                alert('刷新失败');
            });
        }
        function deleteNode(id) {
            if (!confirm('⚠️ 警告：确定要删除此节点吗？\n\n删除后该节点的所有容器、NAT规则等配置信息都将丢失，且无法恢复！')) return;
            $.ajax({
                url: `/api/nodes/${id}`,
                method: 'DELETE',
                success: function(result) {
                    if (result.code === 200) {
                        loadNodes();
                        alert('节点删除成功');
                    } else {
                        alert(result.msg);
                    }
                },
                error: function() {
                    alert('删除失败');
                }
            });
        }
    </script>

    {{template "footer.html" .}}
</body>
</html>
